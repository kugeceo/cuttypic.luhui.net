<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能图片抠图工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .model-progress {
        height: 4px;
        background: linear-gradient(90deg, #3B82F6 0%, #10B981 100%);
        width: 0%;
        transition: width 0.3s ease;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow-sm py-4">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <h1 class="text-xl font-bold text-gray-800">智能图片抠图工具</h1>
      <div class="flex space-x-4">
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100">
          <i class="fa fa-moon-o text-gray-600"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <section class="bg-white rounded-xl shadow-sm p-6 mb-8">
      <h2 class="text-lg font-semibold mb-4">模型加载</h2>
      
      <div class="mb-4">
        <div class="flex justify-between text-sm mb-1">
          <span>加载进度</span>
          <span id="progress-text">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="model-progress" id="model-progress"></div>
        </div>
      </div>
      
      <div class="flex items-center space-x-3 mb-6">
        <div class="animate-spin h-5 w-5 border-2 border-primary border-t-transparent rounded-full" id="loading-spinner"></div>
        <div>
          <div id="status-text">准备加载模型...</div>
          <div class="text-sm text-gray-500" id="status-detail">请稍候</div>
        </div>
      </div>
      
      <div class="flex flex-wrap gap-3 mb-6">
        <button class="model-btn px-4 py-2 bg-primary text-white rounded hover:bg-primary/90" data-model="mobile">
          移动版模型 (快速, ~30MB)
        </button>
        <button class="model-btn px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" data-model="standard">
          标准版模型 (平衡, ~80MB)
        </button>
        <button class="model-btn px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" data-model="advanced">
          高级版模型 (精确, ~150MB)
        </button>
      </div>
      
      <div id="error-container" class="p-4 bg-red-50 border border-red-200 rounded-lg hidden">
        <div class="flex items-start">
          <i class="fa fa-exclamation-circle text-red-500 mt-0.5 mr-3"></i>
          <div>
            <h3 class="font-medium text-red-800 mb-1">加载失败</h3>
            <p class="text-sm text-red-700 mb-2" id="error-message">无法加载模型，请重试</p>
            <button id="retry-btn" class="text-sm text-primary hover:text-primary/80">重试加载</button>
          </div>
        </div>
      </div>
    </section>
    
    <section id="upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hidden">
      <i class="fa fa-cloud-upload text-5xl text-gray-400 mb-4"></i>
      <h3 class="text-xl font-semibold mb-2">拖放图片到此处</h3>
      <p class="text-gray-500 mb-6">或点击下方按钮选择图片</p>
      
      <label class="inline-block bg-secondary hover:bg-secondary/90 text-white font-medium py-3 px-6 rounded-lg cursor-pointer">
        <i class="fa fa-image mr-2"></i>选择图片
        <input type="file" id="file-input" accept="image/*" multiple class="hidden">
      </label>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  
  <script>
  
  
<!-- 
    // 有效的模型链接（已测试不可访问）
    const modelUrls = {
      mobile: 'https://storage.googleapis.com/tfjs-models/savedmodel/body-pix/mobilenet/float/075/model-stride16.json',
      standard: 'https://storage.googleapis.com/tfjs-models/savedmodel/body-pix/resnet50/float/model-stride16.json',
      advanced: 'https://storage.googleapis.com/tfjs-models/savedmodel/pose-detection/blazepose/backbone/model.json'
    };
-->      
	
	
// 替换为国内可访问的模型链接
const modelUrls = {
  mobile: 'https://model-assets.dcloud.net.cn/ai-background-removal/light/model.json',
  standard: 'https://model-assets.dcloud.net.cn/ai-background-removal/standard/model.json',
  advanced: 'https://model-assets.dcloud.net.cn/ai-background-removal/pro/model.json'
};	
	
	
	
	
	
	
    let currentModel = 'mobile';
    let model = null;
    
    // DOM元素
    const modelProgress = document.getElementById('model-progress');
    const progressText = document.getElementById('progress-text');
    const statusText = document.getElementById('status-text');
    const statusDetail = document.getElementById('status-detail');
    const loadingSpinner = document.getElementById('loading-spinner');
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    const retryBtn = document.getElementById('retry-btn');
    const uploadArea = document.getElementById('upload-area');
    const modelBtns = document.querySelectorAll('.model-btn');
    const fileInput = document.getElementById('file-input');
    
    // 初始化
    async function init() {
      try {
        await tf.ready();
        loadModel(currentModel);
      } catch (error) {
        showError('初始化TensorFlow失败: ' + error.message);
      }
    }
    
    // 加载模型
    async function loadModel(modelType) {
      resetUI();
      currentModel = modelType;
      updateModelButtons();
      
      const modelName = {
        mobile: '移动版',
        standard: '标准版',
        advanced: '高级版'
      }[modelType];
      
      statusText.textContent = `正在加载${modelName}模型...`;
      statusDetail.textContent = '连接服务器中...';
      
      try {
        // 监测网络连接
        if (!navigator.onLine) {
          throw new Error('网络连接已断开，请检查网络设置');
        }
        
        // 创建带进度的模型加载
        const response = await fetch(modelUrls[modelType]);
        
        if (!response.ok) {
          throw new Error(`服务器响应错误: ${response.status}`);
        }
        
        const contentLength = parseInt(response.headers.get('Content-Length') || '0', 10);
        
        // 如果知道内容长度，使用精确进度
        if (contentLength) {
          const reader = response.body.getReader();
          let receivedLength = 0;
          const chunks = [];
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            chunks.push(value);
            receivedLength += value.length;
            const progress = Math.round((receivedLength / contentLength) * 100);
            updateProgress(progress);
          }
          
          // 这里是模拟模型解析，实际应用中需要根据模型类型进行解析
          await new Promise(resolve => setTimeout(resolve, 1000));
          updateProgress(100);
        } else {
          // 如果不知道内容长度，使用模拟进度
          let progress = 0;
          const interval = setInterval(() => {
            progress += 5;
            if (progress >= 95) {
              clearInterval(interval);
            }
            updateProgress(progress);
          }, 500);
          
          // 等待模型加载完成
          await response.json();
          clearInterval(interval);
          await new Promise(resolve => setTimeout(resolve, 500));
          updateProgress(100);
        }
        
        // 标记模型为已加载
        model = { loaded: true, type: modelType };
        
        // 更新UI
        statusText.textContent = `${modelName}模型加载完成`;
        statusDetail.textContent = '可以开始处理图片了';
        loadingSpinner.classList.remove('animate-spin');
        uploadArea.classList.remove('hidden');
        
      } catch (error) {
        console.error('模型加载错误:', error);
        showError(error.message);
      }
    }
    
    // 更新进度显示
    function updateProgress(percent) {
      modelProgress.style.width = `${percent}%`;
      progressText.textContent = `${percent}%`;
      
      // 更新状态详情
      const stages = ['连接服务器...', '下载模型文件...', '解析模型数据...', '初始化模型...', '准备就绪...'];
      const stageIndex = Math.min(Math.floor(percent / 20), stages.length - 1);
      statusDetail.textContent = stages[stageIndex];
    }
    
    // 显示错误
    function showError(message) {
      errorMessage.textContent = message;
      errorContainer.classList.remove('hidden');
      loadingSpinner.classList.remove('animate-spin');
    }
    
    // 重置UI状态
    function resetUI() {
      updateProgress(0);
      errorContainer.classList.add('hidden');
      uploadArea.classList.add('hidden');
      loadingSpinner.classList.add('animate-spin');
    }
    
    // 更新模型按钮状态
    function updateModelButtons() {
      modelBtns.forEach(btn => {
        if (btn.dataset.model === currentModel) {
          btn.classList.remove('bg-gray-200', 'text-gray-700');
          btn.classList.add('bg-primary', 'text-white');
        } else {
          btn.classList.remove('bg-primary', 'text-white');
          btn.classList.add('bg-gray-200', 'text-gray-700');
        }
      });
    }
    
    // 事件监听
    function setupEvents() {
      // 模型选择按钮
      modelBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          loadModel(btn.dataset.model);
        });
      });
      
      // 重试按钮
      retryBtn.addEventListener('click', () => {
        loadModel(currentModel);
      });
      
      // 文件选择
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          alert(`已选择 ${e.target.files.length} 张图片，准备处理`);
          // 这里可以添加图片处理逻辑
        }
      });
    }
    
    // 初始化应用
    window.addEventListener('DOMContentLoaded', () => {
      setupEvents();
      init();
    });
  </script>
</body>
</html>
